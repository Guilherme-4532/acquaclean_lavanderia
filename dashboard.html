<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Dashboard AcquaClean</title>
  <link rel="stylesheet" href="css/style.css">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
  <img src="img/logo.png" alt="Logo AcquaClean" class="logo-canto">
  <div class="container">
    <h1>Dashboard AcquaClean</h1>

    <!-- BotÃ£o de Exportar PDF -->
    <button class="btn-exportar" onclick="window.print()">ğŸ“„ Exportar PDF</button>

    <!-- Linha 1: PerÃ­odo -->
    <div class="filtros-linha1">
      <label for="filtro-periodo">PerÃ­odo:
        <select id="filtro-periodo">
          <option value="todos">Todos</option>
          <option value="7dias">Ãšltimos 7 dias</option>
          <option value="mes">MÃªs atual</option>
        </select>
      </label>

      <label for="data-inicio">De:
        <input type="date" id="data-inicio">
      </label>

      <label for="data-fim">AtÃ©:
        <input type="date" id="data-fim">
      </label>
    </div>

    <!-- Linha 2: Filtros adicionais -->
    <div class="filtros-linha2">
      <label for="filtro-tipo">Tipo:
        <select id="filtro-tipo">
          <option value="">Todos</option>
          <option value="entrada">Entrada</option>
          <option value="despesa">Despesa</option>
          <option value="nf">NF</option>
        </select>
      </label>

      <label for="filtro-pagamento">Pagamento:
        <select id="filtro-pagamento">
          <option value="">Todos</option>
          <option value="Dinheiro">Dinheiro</option>
          <option value="CartÃ£o">CartÃ£o</option>
          <option value="PIX">PIX</option>
        </select>
      </label>

      <label for="filtro-item">Item:
        <select id="filtro-item">
          <option value="">Todos</option>
          <option value="Avental">Avental</option>
          <option value="Blazer">Blazer</option>
          <option value="Botina">Botina</option>
          <option value="CalÃ§a social">CalÃ§a social</option>
          <option value="Camisa social manga curta">Camisa social manga curta</option>
          <option value="Camisa social manga longa">Camisa social manga longa</option>
          <option value="Casaco">Casaco</option>
          <option value="Coberdrom">Coberdrom</option>
          <option value="Cobertor">Cobertor</option>
          <option value="Colcha">Colcha</option>
          <option value="Cortina">Cortina</option>
          <option value="Edredom">Edredom</option>
          <option value="Fronha">Fronha</option>
          <option value="Jaleco">Jaleco</option>
          <option value="Jaqueta">Jaqueta</option>
          <option value="LenÃ§ois">LenÃ§ois</option>
          <option value="Manta">Manta</option>
          <option value="Tapete">Tapete</option>
          <option value="Tenis">Tenis</option>
          <option value="Terno">Terno</option>
          <option value="Touca">Touca</option>
          <option value="Travesseiro">Travesseiro</option>
          <option value="Uniforme calÃ§a">Uniforme calÃ§a</option>
          <option value="Uniforme camisa">Uniforme camisa</option>
          <option value="KG">KG</option>
        </select>
      </label>

      <label for="filtro-empresa">Empresa:
        <input type="text" id="filtro-empresa" placeholder="Nome da Empresa">
      </label>

      <div class="bloco-filtrar">
        <button class="btn-filtrar" onclick="carregarDados()" title="Filtrar">ğŸ”</button>
      </div>
    </div>

    <!-- Totalizadores -->
    <div class="totalizadores">
      <div class="card entrada">ğŸ’° Entradas: R$ <span id="total-entrada">0.00</span></div>
      <div class="card despesa">ğŸ“‰ Despesas: R$ <span id="total-despesa">0.00</span></div>
      <div class="card nf">ğŸ“„ NF Emitidas: R$ <span id="total-nf">0.00</span></div>
    </div>
    <div class="card saldo">ğŸ’¼ Saldo Estimado: R$ <span id="total-saldo">0.00</span></div>

    <!-- GrÃ¡ficos principais -->
    <div class="graficos-pares">
      <div id="grafico-por-tipo" class="grafico-container"></div>
      <div id="grafico-por-pagamento" class="grafico-container"></div>
    </div>
    <div id="grafico-por-data"></div>

    <!-- GrÃ¡ficos adicionais -->
    <div class="graficos-pares">
      <div id="grafico-por-item" class="grafico-container"></div>
      <div id="grafico-por-quantidade" class="grafico-container"></div>
    </div>

    <br>
    <a href="index.html">â† Voltar ao Menu Principal</a>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://vqfohtlpdhkzcnyupofk.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxZm9odGxwZGhremNueXVwb2ZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0NTQ4NDcsImV4cCI6MjA2NjAzMDg0N30.XwRRSSHKdRAq6Dh--8lC3V8jcBJLsz21G9vV-IDz6hE';
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function carregarDados() {
      const { data: dados, error } = await supabase.from("registros").select("*");
      if (error) {
        alert("Erro ao carregar dados: " + error.message);
        return;
      }

      const filtroPeriodo = document.getElementById("filtro-periodo").value;
      const inicio = document.getElementById("data-inicio").value;
      const fim = document.getElementById("data-fim").value;
      const filtroTipo = document.getElementById("filtro-tipo").value;
      const filtroPagamento = document.getElementById("filtro-pagamento").value;
      const filtroItem = document.getElementById("filtro-item").value;
      const filtroEmpresa = document.getElementById("filtro-empresa").value.toLowerCase().trim();

      const hoje = new Date();
      const mesAtual = hoje.getMonth();
      const anoAtual = hoje.getFullYear();

      const porTipo = {}, porPagamento = {}, porData = {};
      const porItem = {}, porQuantidade = {};

      let totalEntrada = 0, totalDespesa = 0, totalNF = 0;

      dados.forEach(row => {
        const tipo = row.tipo || "outros";
        const valor = parseFloat(row.valor_total.replace(",", ".")) || 0;
        const pagamento = row.forma_pagamento || "nÃ£o informado";
        const servico = row.itens || "";
        const empresa = (row.nome_empresa || "").toLowerCase().trim();
        const dataStr = row.data || "sem data";
        const qtd = parseFloat(row.peso) || 0;

        const [ano, mes, dia] = dataStr.split("-").length === 3 ? dataStr.split("-") : ["", "", ""];
        const dataRegistro = new Date(`${ano}-${mes}-${dia}`);

        if (!inicio && !fim && filtroPeriodo === "7dias") {
          const diff = (hoje - dataRegistro) / (1000 * 60 * 60 * 24);
          if (diff > 7 || diff < 0) return;
        } else if (!inicio && !fim && filtroPeriodo === "mes") {
          if (dataRegistro.getMonth() !== mesAtual || dataRegistro.getFullYear() !== anoAtual) return;
        }

        if (inicio && dataRegistro < new Date(inicio)) return;
        if (fim && dataRegistro > new Date(fim)) return;
        if (filtroTipo && tipo !== filtroTipo) return;
        if (filtroPagamento && pagamento !== filtroPagamento) return;
        if (filtroItem && !servico.includes(filtroItem)) return;
        if (filtroEmpresa && !empresa.includes(filtroEmpresa)) return;

        porTipo[tipo] = (porTipo[tipo] || 0) + valor;
        porPagamento[pagamento] = (porPagamento[pagamento] || 0) + valor;
        porData[dataStr] = (porData[dataStr] || 0) + valor;
        porItem[servico] = (porItem[servico] || 0) + valor;
        porQuantidade[servico] = (porQuantidade[servico] || 0) + qtd;

        if (tipo === "entrada") totalEntrada += valor;
        if (tipo === "despesa") totalDespesa += valor;
        if (tipo === "nf") totalNF += valor;
      });

      document.getElementById("total-entrada").textContent = totalEntrada.toFixed(2);
      document.getElementById("total-despesa").textContent = totalDespesa.toFixed(2);
      document.getElementById("total-nf").textContent = totalNF.toFixed(2);
      document.getElementById("total-saldo").textContent = (totalEntrada - totalDespesa).toFixed(2);

      desenharGraficoPizza("grafico-por-tipo", "Valores por Tipo de Registro", porTipo);
      desenharGraficoPizza("grafico-por-pagamento", "Valores por Forma de Pagamento", porPagamento);
      desenharGraficoColuna("grafico-por-data", "Totais por Data", porData);
      desenharGraficoColuna("grafico-por-item", "Totais por Item/ServiÃ§o (R$)", porItem);
      desenharGraficoColuna("grafico-por-quantidade", "Quantidade/Peso por Item", porQuantidade);
    }

    function desenharGraficoPizza(elementId, titulo, dadosObj) {
      const dataArray = [["Categoria", "Valor"]];
      for (const chave in dadosObj) {
        dataArray.push([chave, dadosObj[chave]]);
      }
      const data = google.visualization.arrayToDataTable(dataArray);
      const options = {
        title: titulo,
        pieHole: 0.4,
        legend: { position: "right" },
        chartArea: { width: "90%", height: "80%" }
      };
      const chart = new google.visualization.PieChart(document.getElementById(elementId));
      chart.draw(data, options);
    }

    function desenharGraficoColuna(elementId, titulo, dadosObj) {
      const dataArray = [["Categoria", "Valor"]];
      Object.keys(dadosObj).sort().forEach(key => {
        dataArray.push([key, dadosObj[key]]);
      });
      const data = google.visualization.arrayToDataTable(dataArray);
      const options = {
        title: titulo,
        legend: { position: "none" },
        hAxis: { title: "Categoria" },
        vAxis: { title: "Valor" },
        chartArea: { width: "90%", height: "70%" }
      };
      const chart = new google.visualization.ColumnChart(document.getElementById(elementId));
      chart.draw(data, options);
    }
    
    document.getElementById("filtro-periodo").addEventListener("change", carregarDados);
    window.addEventListener("load", () => {
      google.charts.load("current", { packages: ["corechart"] });
      google.charts.setOnLoadCallback(carregarDados);
    });

  </script>
  <footer class="rodape">
    <p>&copy; <span id="ano-atual"></span> Lavanderia AcquaClean. Todos os direitos reservados.</p>
  </footer>
  <script>
    document.getElementById("ano-atual").textContent = new Date().getFullYear();
  </script>
</body>

</html>
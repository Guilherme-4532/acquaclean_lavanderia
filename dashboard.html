<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Dashboard AcquaClean</title>
  <link rel="stylesheet" href="css/style.css">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
  <img src="img/logo.png" alt="Logo AcquaClean" class="logo-canto">
  <div class="container">
    <h1>Dashboard AcquaClean</h1>

    <button class="btn-exportar" onclick="window.print()">📄 Exportar PDF</button>

    <div class="filtros-linha1">
      <label for="filtro-periodo">Período:
        <select id="filtro-periodo">
          <option value="todos">Todos</option>
          <option value="7dias">Últimos 7 dias</option>
          <option value="mes">Mês atual</option>
        </select>
      </label>

      <label for="data-inicio">De:
        <input type="date" id="data-inicio">
      </label>

      <label for="data-fim">Até:
        <input type="date" id="data-fim">
      </label>
    </div>

    <div class="filtros-linha2">
      <label for="filtro-tipo">Tipo:
        <select id="filtro-tipo">
          <option value="">Todos</option>
          <option value="entrada">Entrada</option>
          <option value="despesa">Despesa</option>
          <option value="nf">NF</option>
        </select>
      </label>

      <label for="filtro-pagamento">Pagamento:
        <select id="filtro-pagamento">
          <option value="">Todos</option>
          <option value="Dinheiro">Dinheiro</option>
          <option value="Cartão">Cartão</option>
          <option value="PIX">PIX</option>
        </select>
      </label>

      <label for="filtro-item">Item:
        <select id="filtro-item">
          <option value="">Todos</option>
          <option value="KG">KG</option>
          <!-- incluir demais itens se desejar -->
        </select>
      </label>

      <label for="filtro-empresa">Empresa:
        <input type="text" id="filtro-empresa" placeholder="Nome da Empresa">
      </label>

      <div class="bloco-filtrar">
        <button class="btn-filtrar" onclick="carregarDados()" title="Filtrar">🔍</button>
      </div>
    </div>

    <div class="totalizadores">
      <div class="card entrada">💰 Entradas: R$ <span id="total-entrada">0.00</span></div>
      <div class="card despesa">📉 Despesas: R$ <span id="total-despesa">0.00</span></div>
      <div class="card nf">📄 NF Emitidas: R$ <span id="total-nf">0.00</span></div>
    </div>
    <div class="card saldo">💼 Saldo Estimado: R$ <span id="total-saldo">0.00</span></div>

    <div class="graficos-pares">
      <div id="grafico-por-tipo" class="grafico-container"></div>
      <div id="grafico-por-pagamento" class="grafico-container"></div>
    </div>
    <div id="grafico-por-data"></div>
    <div class="graficos-pares">
      <div id="grafico-por-item" class="grafico-container"></div>
      <div id="grafico-por-quantidade" class="grafico-container"></div>
    </div>
    <div id="grafico-comparativo"></div>

    <br>
    <a href="index.html">← Voltar ao Menu Principal</a>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://vqfohtlpdhkzcnyupofk.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxZm9odGxwZGhremNueXVwb2ZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0NTQ4NDcsImV4cCI6MjA2NjAzMDg0N30.XwRRSSHKdRAq6Dh--8lC3V8jcBJLsz21G9vV-IDz6hE'
    );

    let dadosBrutos = [];

    function formatarNumero(valor) {
      return "R$ " + valor.toFixed(2).replace('.', ',');
    }

    function legendaCentralizada() {
      return {
        position: 'bottom',
        alignment: 'center',
      };
    }

    function gerarCores(tipo) {
      switch (tipo) {
        case 'entrada': return '#4CAF50'; // verde
        case 'despesa': return '#F44336'; // vermelho
        case 'nf': return '#2196F3'; // azul
        default: return '#9E9E9E';
      }
    }

    async function carregarDados() {
        const filtroPeriodo = document.getElementById("filtro-periodo").value;
        const inicio = document.getElementById("data-inicio").value;
        const fim = document.getElementById("data-fim").value;
        const filtroTipo = document.getElementById("filtro-tipo").value;
        const filtroPagamento = document.getElementById("filtro-pagamento").value;
        const filtroItem = document.getElementById("filtro-item").value;
        const filtroEmpresa = document.getElementById("filtro-empresa").value.toLowerCase().trim();

        const hoje = new Date();
        const mesAtual = hoje.getMonth();
        const anoAtual = hoje.getFullYear();
        const { data, error } = await supabase.from('registros').select('*');
        if (error) return alert("Erro: " + error.message);

        dadosBrutos = data.filter(row => {
          const dataRegistro = new Date(row.data);
          const tipo = row.tipo || "";
          const pagamento = row.forma_pagamento || "";
          const servico = row.itens || "";
          const empresa = (row.nome_empresa || "").toLowerCase();

          if (filtroPeriodo === "7dias") {
            const diff = (hoje - dataRegistro) / (1000 * 60 * 60 * 24);
            if (diff > 7 || diff < 0) return false;
          } else if (filtroPeriodo === "mes") {
            if (dataRegistro.getMonth() !== mesAtual || dataRegistro.getFullYear() !== anoAtual) return false;
          }

          if (inicio && dataRegistro < new Date(inicio)) return false;
          if (fim && dataRegistro > new Date(fim)) return false;
          if (filtroTipo && tipo !== filtroTipo) return false;
          if (filtroPagamento && pagamento !== filtroPagamento) return false;
          if (filtroItem && !servico.includes(filtroItem)) return false;
          if (filtroEmpresa && !empresa.includes(filtroEmpresa)) return false;

          return true;
        });

        // chama aqui suas funções de filtro, cálculo e desenho de gráficos
        // como exemplo:
        desenharGraficoPizza("grafico-por-tipo", "Valores por Tipo de Registro", agruparValores("tipo"));
        desenharGraficoPizza("grafico-por-pagamento", "Valores por Forma de Pagamento", agruparValores("forma_pagamento"));
        desenharGraficoColunaEmpilhada("grafico-por-data", "Totais por Mês", agruparTotaisMensais());
        desenharGraficoPizza("grafico-por-item", "Totais por Item (Entradas)", agruparItensEntrada());
        desenharGraficoColunaSimples("grafico-por-quantidade", "KG Lavados por Mês", agruparKGMensal());
        desenharGraficoComparativo("grafico-comparativo", "Comparativo Mensal por Tipo", agruparComparativoMensal());

        // Atualizar totalizadores
        let totalEntrada = 0, totalDespesa = 0, totalNF = 0;
        dadosBrutos.forEach(row => {
          const valor = parseFloat(row.valor_total || 0);
          if (row.tipo === "entrada") totalEntrada += valor;
          if (row.tipo === "despesa") totalDespesa += valor;
          if (row.tipo === "nf") totalNF += valor;
        });
        document.getElementById("total-entrada").textContent = totalEntrada.toFixed(2);
        document.getElementById("total-despesa").textContent = totalDespesa.toFixed(2);
        document.getElementById("total-nf").textContent = totalNF.toFixed(2);
        document.getElementById("total-saldo").textContent = (totalEntrada + totalNF - totalDespesa).toFixed(2);
    }

    function agruparValores(chave) {
      const resultado = {};
      dadosBrutos.forEach(row => {
        const valor = parseFloat(row.valor_total || 0);
        const k = row[chave] || "Indefinido";
        resultado[k] = (resultado[k] || 0) + valor;
      });
      return resultado;
    }

    function agruparTotaisMensais() {
      const meses = {};
      dadosBrutos.forEach(row => {
        const tipo = row.tipo;
        const valor = parseFloat(row.valor_total || 0);
        const data = new Date(row.data);
        const chave = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
        if (!meses[chave]) meses[chave] = { entrada: 0, despesa: 0, nf: 0 };
        if (meses[chave][tipo] !== undefined) meses[chave][tipo] += valor;
      });
      return meses;
    }

    function agruparItensEntrada() {
      const itens = {};
      dadosBrutos.forEach(row => {
        if (row.tipo !== "entrada") return;
        const nomes = row.itens ? row.itens.replace(/[\[\]"]+/g, '').split(',') : [];
        const valor = parseFloat(row.valor_total || 0);
        nomes.forEach(item => {
          itens[item.trim()] = (itens[item.trim()] || 0) + valor;
        });
      });
      return itens;
    }

    function agruparKGMensal() {
      const kg = {};
      dadosBrutos.forEach(row => {
        if (row.tipo === "entrada" && row.itens.includes("KG")) {
          const data = new Date(row.data);
          const chave = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
          const peso = parseFloat(row.peso || 0);
          kg[chave] = (kg[chave] || 0) + peso;
        }
      });
      return kg;
    }

    function agruparComparativoMensal() {
      const dados = agruparTotaisMensais();
      const resultado = [["Mês", "Entradas", "Despesas", "NF"]];
      Object.keys(dados).sort().forEach(mes => {
        resultado.push([mes, dados[mes].entrada, dados[mes].despesa, dados[mes].nf]);
      });
      return resultado;
    }

    function desenharGraficoPizza(id, titulo, dadosObj) {
      const dataArray = [["Categoria", "Valor"]];
      for (const chave in dadosObj) {
        dataArray.push([chave, dadosObj[chave]]);
      }
      const data = google.visualization.arrayToDataTable(dataArray);
      const chart = new google.visualization.PieChart(document.getElementById(id));
      chart.draw(data, {
        title: titulo,
        pieHole: 0.4,
        chartArea: { width: "90%", height: "80%" },
        legend: legendaCentralizada()
      });
    }

    function desenharGraficoColunaEmpilhada(id, titulo, dadosObj) {
      const dataArray = [["Mês", "Entrada", "Despesa", "NF", { role: 'annotation' }]];
      Object.keys(dadosObj).sort().forEach(mes => {
        const d = dadosObj[mes];
        const total = d.entrada + d.nf - d.despesa;
        dataArray.push([mes, d.entrada, d.despesa, d.nf, formatarNumero(total)]);
      });
      const data = google.visualization.arrayToDataTable(dataArray);
      const chart = new google.visualization.ColumnChart(document.getElementById(id));
      chart.draw(data, {
        title: titulo,
        legend: { position: "top" },
        isStacked: true,
        chartArea: { width: "90%", height: "70%" },
        annotations: { alwaysOutside: true }
      });
    }

    function desenharGraficoColunaSimples(id, titulo, dadosObj) {
      const dataArray = [["Mês", "KG", { role: 'annotation' }]];
      let acumulado = 0;
      Object.keys(dadosObj).sort().forEach(mes => {
        acumulado += dadosObj[mes];
        dataArray.push([mes, dadosObj[mes], acumulado.toFixed(0) + " KG"]);
      });
      const data = google.visualization.arrayToDataTable(dataArray);
      const chart = new google.visualization.ColumnChart(document.getElementById(id));
      chart.draw(data, {
        title: titulo,
        legend: { position: "none" },
        chartArea: { width: "90%", height: "70%" },
        annotations: { alwaysOutside: true }
      });
    }

    function desenharGraficoComparativo(id, titulo, dadosArray) {
      const data = google.visualization.arrayToDataTable(dadosArray);
      const chart = new google.visualization.ColumnChart(document.getElementById(id));
      chart.draw(data, {
        title: titulo,
        legend: { position: "top" },
        chartArea: { width: "90%", height: "70%" },
        annotations: { alwaysOutside: true }
      });
    }

    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(carregarDados);
    window.carregarDados = carregarDados;
  </script>

  <footer class="rodape">
    <p>&copy; <span id="ano-atual"></span> Lavanderia AcquaClean. Todos os direitos reservados.</p>
  </footer>
  <script>
    document.getElementById("ano-atual").textContent = new Date().getFullYear();
  </script>
</body>

</html>

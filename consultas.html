<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Consultas e Registros</title>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <img src="img/logo.png" alt="Logo AcquaClean" class="logo-canto">
  <div class="container">
    <h1>Consultas e Registros</h1>
    <p class="titulo-print" style="display: none;">Lavanderia AcquaClean - Relat√≥rio de Registros</p>


    <!-- Bot√£o Exportar -->
    <button class="btn-exportar" onclick="window.print()">üìÑ Exportar PDF</button>
    <button class="btn-exportar" onclick="exportarParaExcel()">üìä Exportar Excel</button>


    <!-- Filtros linha 1 -->
    <div class="filtros-linha1">
      <label for="filtro-periodo">Per√≠odo:
        <select id="filtro-periodo">
          <option value="todos">Todos</option>
          <option value="7dias">√öltimos 7 dias</option>
          <option value="mes">M√™s atual</option>
          <option value="mes_anterior">M√™s anterior</option>
        </select>
      </label>

      <label for="data-inicio">De:
        <input type="date" id="data-inicio">
      </label>

      <label for="data-fim">At√©:
        <input type="date" id="data-fim">
      </label>
    </div>

    <!-- Filtros linha 2 -->
    <div class="filtros-linha2">
      <label for="filtro-tipo">Tipo:
        <select id="filtro-tipo">
          <option value="">Todos</option>
          <option value="entrada">Entrada</option>
          <option value="despesa">Despesa</option>
          <option value="nf">NF</option>
        </select>
      </label>

      <label for="filtro-pagamento">Pagamento:
        <select id="filtro-pagamento">
          <option value="">Todos</option>
          <option value="Dinheiro">Dinheiro</option>
          <option value="Cart√£o">Cart√£o</option>
          <option value="Boleto">Boleto</option>
          <option value="PIX">PIX</option>
        </select>
      </label>

      <label for="filtro-item">Item:
        <select id="filtro-item">
          <option value="">Todos</option>
          <option value="Avental">Avental</option>
          <option value="Blazer">Blazer</option>
          <option value="Botina">Botina</option>
          <option value="Cal√ßa social">Cal√ßa social</option>
          <option value="Camisa social manga curta">Camisa social manga curta</option>
          <option value="Camisa social manga longa">Camisa social manga longa</option>
          <option value="Casaco">Casaco</option>
          <option value="Coberdrom">Coberdrom</option>
          <option value="Cobertor">Cobertor</option>
          <option value="Colcha">Colcha</option>
          <option value="Cortina">Cortina</option>
          <option value="Edredom">Edredom</option>
          <option value="Fronha">Fronha</option>
          <option value="Jaleco">Jaleco</option>
          <option value="Jaqueta">Jaqueta</option>
          <option value="Len√ßois">Len√ßois</option>
          <option value="Manta">Manta</option>
          <option value="Tapete">Tapete</option>
          <option value="Tenis">Tenis</option>
          <option value="Terno">Terno</option>
          <option value="Touca">Touca</option>
          <option value="Travesseiro">Travesseiro</option>
          <option value="Uniforme cal√ßa">Uniforme cal√ßa</option>
          <option value="Uniforme camisa">Uniforme camisa</option>
          <option value="KG">KG</option>
        </select>
      </label>

      <label for="filtro-empresa">Empresa:
        <select id="filtro-empresa">
          <option value="">Todas</option>
          <!-- op√ß√µes ser√£o preenchidas via JavaScript -->
        </select>
      </label>


      <div class="bloco-filtrar">
        <button class="btn-filtrar" onclick="carregarDados()" title="Filtrar">üîç</button>
        <button class="btn-filtrar" onclick="limparFiltros()" title="Limpar">‚ôª</button>
      </div>
    </div>

    <!-- Tabela -->
    <!-- Tabela com cabe√ßalho fixo -->
    <div class="tabela-container">
      <table id="tabela" border="1" style="width: 100%;">
        <thead></thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="100%" style="text-align: right; font-weight: bold;">
              Total: R$ <span id="total-geral">0.00</span>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
    <br>
    <a href="index.html">‚Üê Voltar ao Menu Principal</a>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://vqfohtlpdhkzcnyupofk.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZxZm9odGxwZGhremNueXVwb2ZrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0NTQ4NDcsImV4cCI6MjA2NjAzMDg0N30.XwRRSSHKdRAq6Dh--8lC3V8jcBJLsz21G9vV-IDz6hE';
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function carregarDados() {
      const { data: dados, error } = await supabase.from("registros").select("*");
      if (error) {
        alert("Erro ao carregar dados: " + error.message);
        return;
      }

      const filtroPeriodo = document.getElementById("filtro-periodo").value;
      const inicio = document.getElementById("data-inicio").value;
      const fim = document.getElementById("data-fim").value;
      const filtroTipo = document.getElementById("filtro-tipo").value;
      const filtroPagamento = document.getElementById("filtro-pagamento").value;
      const filtroItem = document.getElementById("filtro-item").value;
      const filtroEmpresa = document.getElementById("filtro-empresa").value;

      const hoje = new Date();
      const mesAtual = hoje.getMonth();
      const anoAtual = hoje.getFullYear();

      const thead = document.querySelector("#tabela thead");
      const tbody = document.querySelector("#tabela tbody");
      const totalGeral = document.getElementById("total-geral");
      tbody.innerHTML = "";
      totalGeral.textContent = "0.00";
      let totalValor = 0;

      // Cabe√ßalhos din√¢micos
      if (!filtroTipo) {
        thead.innerHTML = `
      <tr>
        <th>Tipo</th>
        <th>Data</th>
        <th>Descri√ß√£o / Itens</th>
        <th>Quantidade</th>
        <th>Peso</th>
        <th>Valor (R$)</th>
        <th>Forma Pagamento</th>
        <th>Empresa / N¬∫ NF / N¬∫ Comanda</th>
      </tr>`;
      } else if (filtroTipo === "entrada") {
        thead.innerHTML = `
      <tr>
        <th>Data</th>
        <th>N¬∫ Comanda</th>
        <th>Forma Pagamento</th>
        <th>Itens</th>
        <th>Peso</th>
        <th>Quantidade</th>
        <th>Valor (R$)</th>
      </tr>`;
      } else if (filtroTipo === "despesa") {
        thead.innerHTML = `
      <tr>
        <th>Data</th>
        <th>Descri√ß√£o</th>
        <th>Quantidade</th>
        <th>Valor (R$)</th>
        <th>Forma Pagamento</th>
      </tr>`;
      } else if (filtroTipo === "nf") {
        thead.innerHTML = `
      <tr>
        <th>Data</th>
        <th>N¬∫ NF</th>
        <th>Empresa</th>
        <th>Valor (R$)</th>
        <th>Forma Pagamento</th>
      </tr>`;
      }

      dados.forEach(row => {
        const tipo = row.tipo || "";
        const dataStr = row.data || "";
        const pagamento = row.forma_pagamento || "";
        const empresa = (row.nome_empresa || "").toLowerCase().trim();

        let itensArray = [];
        try {
          itensArray = Array.isArray(row.itens) ? row.itens : JSON.parse(row.itens || "[]");
          if (!Array.isArray(itensArray)) itensArray = [];
        } catch (e) {
          itensArray = [];
        }

        let quantidadesArray = [];
        try {
          quantidadesArray = Array.isArray(row.quantidades) ? row.quantidades : JSON.parse(row.quantidades || "[]");
          if (!Array.isArray(quantidadesArray)) quantidadesArray = [];
        } catch (e) {
          quantidadesArray = [];
        }

        const peso = row.peso || "-";
        const valor = parseFloat((row.valor_total || "0").toString().replace(",", ".")) || 0;
        const dataRegistro = new Date(dataStr);
        if (isNaN(dataRegistro)) return;

        // Filtros
        if (filtroPeriodo === "7dias") {
          const seteDiasAtras = new Date();
          seteDiasAtras.setDate(hoje.getDate() - 7);
          if (dataRegistro < seteDiasAtras || dataRegistro > hoje) return;
        }
        if (filtroPeriodo === "mes") {
          if (dataRegistro.getMonth() !== mesAtual || dataRegistro.getFullYear() !== anoAtual) return;
        }
        if (filtroPeriodo === "mes_anterior") {
          const mesAnterior = mesAtual === 0 ? 11 : mesAtual - 1;
          const anoMesAnterior = mesAtual === 0 ? anoAtual - 1 : anoAtual;
          if (dataRegistro.getMonth() !== mesAnterior || dataRegistro.getFullYear() !== anoMesAnterior) return;
        }
        if (inicio && dataRegistro < new Date(inicio)) return;
        if (fim && dataRegistro > new Date(fim)) return;
        if (filtroTipo && tipo.toLowerCase() !== filtroTipo.toLowerCase()) return;
        if (filtroPagamento && pagamento !== filtroPagamento) return;
        if (filtroItem && !itensArray.includes(filtroItem)) return;
        if (filtroEmpresa && row.nome_empresa !== filtroEmpresa) return;


        totalValor += valor;

        const tr = document.createElement("tr");

        if (tipo === "despesa") {
          tr.style.color = "#c0392b"; // vermelho escuro
        } else if (tipo === "entrada" || tipo === "nf") {
          tr.style.color = "#27ae60"; // verde forte
        }


        if (!filtroTipo) {
          tr.innerHTML = `
        <td>${tipo}</td>
        <td>${dataStr}</td>
        <td>${row.descricao || itensArray.join(", ") || "-"}</td>
        <td>${quantidadesArray.join(", ") || "-"}</td>
        <td>${peso || "-"}</td>
        <td>${valor.toFixed(2)}</td>
        <td>${pagamento}</td>
        <td>${row.nome_empresa || row.numero_nf || row.numero_comanda || "-"}</td>
      `;
        }

        if (filtroTipo === "entrada") {
          tr.innerHTML = `
        <td>${dataStr}</td>
        <td>${row.numero_comanda || "-"}</td>
        <td>${pagamento}</td>
        <td>${itensArray.join(", ")}</td>
        <td>${peso}</td>
        <td>${quantidadesArray.join(", ")}</td>
        <td>${valor.toFixed(2)}</td>
      `;
        }

        if (filtroTipo === "despesa") {
          const qtd = quantidadesArray.length > 0 ? quantidadesArray.join(", ") : (row.quantidades || "-");
          tr.innerHTML = `
    <td>${dataStr}</td>
    <td>${row.descricao || "-"}</td>
    <td>${qtd}</td>
    <td>${valor.toFixed(2)}</td>
    <td>${pagamento}</td>
  `;
        }


        if (filtroTipo === "nf") {
          tr.innerHTML = `
        <td>${dataStr}</td>
        <td>${row.numero_nf || "-"}</td>
        <td>${row.nome_empresa || "-"}</td>
        <td>${valor.toFixed(2)}</td>
        <td>${pagamento}</td>
      `;
        }

        tbody.appendChild(tr);
      });

      totalGeral.textContent = totalValor.toFixed(2);
    }
    async function preencherFiltroEmpresa() {
      const { data, error } = await supabase
        .from("registros")
        .select("nome_empresa")
        .neq("nome_empresa", null); // ignora registros nulos

      if (error) {
        console.error("Erro ao carregar empresas:", error.message);
        return;
      }

      // Cria um array com nomes √∫nicos
      const empresasUnicas = [...new Set(data.map(e => e.nome_empresa).filter(Boolean))].sort();

      // Preenche o select
      const select = document.getElementById("filtro-empresa");

      empresasUnicas.forEach(nome => {
        const opt = document.createElement("option");
        opt.value = nome;
        opt.textContent = nome;
        select.appendChild(opt);
      });
    }
    window.addEventListener("DOMContentLoaded", () => {
      preencherFiltroEmpresa();
    });



    function limparFiltros() {
      document.getElementById("filtro-periodo").value = "todos";
      document.getElementById("data-inicio").value = "";
      document.getElementById("data-fim").value = "";
      document.getElementById("filtro-tipo").value = "";
      document.getElementById("filtro-pagamento").value = "";
      document.getElementById("filtro-item").value = "";
      document.getElementById("filtro-empresa").value = "";
      carregarDados();
    }

    // Expor fun√ß√µes globalmente para funcionar com onclick no HTML
    window.carregarDados = carregarDados;
    window.limparFiltros = limparFiltros;

    // Executar carregamento inicial ao abrir a p√°gina
    window.onload = () => {
      carregarDados();
      document.getElementById("ano-atual").textContent = new Date().getFullYear();
    };
  </script>
  <footer class="rodape">
    <p>&copy; <span id="ano-atual"></span> Lavanderia AcquaClean. Todos os direitos reservados.</p>
  </footer>
  <script>
    function exportarParaExcel() {
      const tabela = document.getElementById("tabela");
      const html = tabela.outerHTML.replace(/ /g, '%20');

      const nomeArquivo = `registros_acquaclean_${new Date().toLocaleDateString('pt-BR')}.xls`;

      const link = document.createElement('a');
      link.href = 'data:application/vnd.ms-excel,' + html;
      link.download = nomeArquivo;
      link.click();
    }
  </script>
</body>

</html>